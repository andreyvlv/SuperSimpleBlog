!function(){function c(e){return CKEDITOR.tools.capitalize(e,!0)}function u(l,e){function g(s){return function(e,a){var t=e.widgets.focused,i=CKEDITOR.TRISTATE_DISABLED;t&&"easyimage"===t.name&&(i=s&&s.call(this,t,e,a)?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF),this.setState(i)}}l.addCommand("easyimageAlt",new CKEDITOR.dialogCommand("easyimageAlt",{startDisabled:!0,contextSensitive:!0,refresh:g()})),function(a){function t(e,a){var t=e.match(/^easyimage(.+)$/);if(t){var i=(t[1][0]||"").toLowerCase()+t[1].substr(1);if(t[1]in a)return t[1];if(i in a)return i}}for(var e in l.on("afterCommandExec",function(e){t(e.data.name,a)&&(l.forceNextSelectionCheck(),l.selectionChange(!0))}),l.on("beforeCommandExec",function(e){t(e.data.name,a)&&e.data.command.style.checkActive(e.editor.elementPath(),l)&&(e.cancel(),l.focus())}),a)i=l,n=a[s=e],o="easyimage"+c(e),n.type="widget",n.widget="easyimage",n.group=n.group||"easyimage",n.element="figure",s=new CKEDITOR.style(n),i.filter.allow(s),(s=new CKEDITOR.styleCommand(s)).contextSensitive=!0,s.refresh=g(function(e,a,t){return this.style.checkActive(t,a)}),i.addCommand(o,s),(s=i.getCommand(o)).enable=function(){},s.refresh(i,i.elementPath());var i,s,n,o}(e)}function f(a){var t=a.sender.editor,e=t.config.easyimage_toolbar;e.split&&(e=e.split(",")),CKEDITOR.tools.array.forEach(e,function(e){e=t.ui.items[e],a.data[e.name]=t.getCommand(e.command).state})}var a=!1,y=["jpeg","png","gif","bmp"];CKEDITOR.plugins.easyimage={_parseSrcSet:function(e){var a,t=[];for(a in e)"default"!==a&&t.push(e[a]+" "+a+"w");return t.join(", ")}},CKEDITOR.plugins.add("easyimage",{requires:"imagebase,balloontoolbar,button,dialog,cloudservices",lang:"en",icons:"easyimagefull,easyimageside,easyimagealt,easyimagealignleft,easyimagealigncenter,easyimagealignright,easyimageupload",hidpi:!0,onLoad:function(){CKEDITOR.dialog.add("easyimageAlt",this.path+"dialogs/easyimagealt.js")},isSupportedEnvironment:function(){return!CKEDITOR.env.ie||11<=CKEDITOR.env.version},init:function(e){this.isSupportedEnvironment()&&(a||(CKEDITOR.document.appendStyleSheet(this.path+"styles/easyimage.css"),a=!0),e.addContentsCss&&e.addContentsCss(this.path+"styles/easyimage.css"))},afterInit:function(e){if(this.isSupportedEnvironment()){var a=CKEDITOR.tools.object.merge({full:{attributes:{class:"easyimage-full"},label:e.lang.easyimage.commands.fullImage},side:{attributes:{class:"easyimage-side"},label:e.lang.easyimage.commands.sideImage},alignLeft:{attributes:{class:"easyimage-align-left"},label:e.lang.common.alignLeft},alignCenter:{attributes:{class:"easyimage-align-center"},label:e.lang.common.alignCenter},alignRight:{attributes:{class:"easyimage-align-right"},label:e.lang.common.alignRight}},e.config.easyimage_styles);for(var t in l=a,g=(r=(o=e).config).easyimage_class,r={name:"easyimage",allowedContent:{figure:{classes:r.easyimage_sideClass},img:{attributes:"!src,srcset,alt,width,sizes"}},requiredContent:"figure; img[!src]",styleableElements:"figure",supportedTypes:new RegExp("image/("+y.join("|")+")","i"),loaderType:CKEDITOR.plugins.cloudservices.cloudServicesLoader,progressReporterType:CKEDITOR.plugins.imagebase.progressBar,upcasts:{figure:function(e){if((!g||e.hasClass(g))&&1===e.find("img",!0).length)return e}},init:function(){function e(e,a){var t=e.$;if(t.complete&&t.naturalWidth)return a(t.naturalWidth);e.once("load",function(){a(t.naturalWidth)})}var a=this.parts.image;a&&!a.$.complete&&e(a,function(){o._.easyImageToolbarContext.toolbar.reposition()}),void 0!==(a=this.element.data("cke-upload-id"))&&(this.setData("uploadId",a),this.element.data("cke-upload-id",!1)),this.on("contextMenu",f),o.config.easyimage_class&&this.addClass(o.config.easyimage_class),this.on("uploadStarted",function(){var a=this;e(a.parts.image,function(e){a.parts.image.hasAttribute("width")||(a.editor.fire("lockSnapshot"),a.parts.image.setAttribute("width",e),a.editor.fire("unlockSnapshot"))})}),this.on("uploadDone",function(e){e=e.data.loader.responseData.response;var a=CKEDITOR.plugins.easyimage._parseSrcSet(e);this.parts.image.setAttributes({"data-cke-saved-src":e.default,src:e.default,srcset:a,sizes:"100vw"})}),this.on("uploadFailed",function(){alert(this.editor.lang.easyimage.uploadFailed)}),this._loadDefaultStyle()},_loadDefaultStyle:function(){var e,a=!1,t=o.config.easyimage_defaultStyle;for(e in l){var i=o.getCommand("easyimage"+c(e));!a&&i&&i.style&&-1!==CKEDITOR.tools.array.indexOf(i.style.group,"easyimage")&&this.checkStyleActive(i.style)&&(a=!0)}!a&&t&&o.getCommand("easyimage"+c(t))&&this.applyStyle(o.getCommand("easyimage"+c(t)).style)}},g&&(r.requiredContent+="(!"+g+")",r.allowedContent.figure.classes="!"+g+","+r.allowedContent.figure.classes),o.plugins.link&&(r=CKEDITOR.plugins.imagebase.addFeature(o,"link",r)),r=CKEDITOR.plugins.imagebase.addFeature(o,"upload",r),r=CKEDITOR.plugins.imagebase.addFeature(o,"caption",r),CKEDITOR.plugins.imagebase.addImageWidget(o,"easyimage",r),m=e,d=new RegExp("<img[^>]*\\ssrc=[\\'\\\"]?data:image/("+y.join("|")+");base64,","i"),m.on("paste",function(e){if(!m.isReadOnly&&d.test(e.data.dataValue)){e=e.data;var a,t,i,s,n=document.implementation.createHTMLDocument(""),n=new CKEDITOR.dom.element(n.body),o=m.widgets.registered.easyimage,l=0;for(n.data("cke-editable",1),n.appendHtml(e.dataValue),t=n.find("img"),s=0;s<t.count();s++){var g=(a=(i=t.getItem(s)).getAttribute("src"))&&"data:"==a.substring(0,5),r=null===i.data("cke-realelement");g&&r&&!i.isReadOnly(1)&&(1<++l&&((g=m.getSelection().getRanges())[0].enlarge(CKEDITOR.ENLARGE_ELEMENT),g[0].collapse(!1)),a.match(/image\/([a-z]+?);/i),g=o._spawnLoader(m,a,o),(a=o._insertWidget(m,o,a,!1,{uploadId:g.id})).data("cke-upload-id",g.id),a.replace(i))}e.dataValue=n.getHtml()}}),u(e,a),e.ui.addButton("EasyImageAlt",{label:e.lang.easyimage.commands.altText,command:"easyimageAlt",toolbar:"easyimage,3"}),a)e.ui.addButton("EasyImage"+c(t),{label:a[t].label,command:"easyimage"+c(t),toolbar:"easyimage,99",icon:a[t].icon,iconHiDpi:a[t].iconHiDpi});n=(s=e).config.easyimage_toolbar,s.plugins.contextmenu&&(n.split&&(n=n.split(",")),s.addMenuGroup("easyimage"),CKEDITOR.tools.array.forEach(n,function(e){e=s.ui.items[e],s.addMenuItem(e.name,{label:e.label,command:e.command,group:"easyimage"})})),a=e.config.easyimage_toolbar,e._.easyImageToolbarContext=e.balloonToolbars.create({buttons:a.join?a.join(","):a,widgets:["easyimage"]}),(i=e).ui.addButton("EasyImageUpload",{label:i.lang.easyimage.commands.upload,command:"easyimageUpload",toolbar:"insert,1"}),i.addCommand("easyimageUpload",{exec:function(){var e=CKEDITOR.dom.element.createFromHtml('<input type="file" accept="image/*" multiple="multiple">');e.once("change",function(e){(e=e.data.getTarget()).$.files.length&&i.fire("paste",{method:"paste",dataValue:"",dataTransfer:new CKEDITOR.plugins.clipboard.dataTransfer({files:e.$.files})})}),e.$.click()}})}var i,s,n,m,d,o,l,g,r}}),CKEDITOR.config.easyimage_class="easyimage",CKEDITOR.config.easyimage_styles={},CKEDITOR.config.easyimage_defaultStyle="full",CKEDITOR.config.easyimage_toolbar=["EasyImageFull","EasyImageSide","EasyImageAlt"]}();